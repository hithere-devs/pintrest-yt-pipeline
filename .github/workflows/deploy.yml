# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and deploy using PM2
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js Backend CI/CD

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

env:
  APP_PORT: 4000
  APP_NAME: clipmil-be
  DOMAIN: api.clipmil.com
  CERTBOT_EMAIL: azhar@bizer.dev

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - name: Update and upgrade Ubuntu
        run: |
          echo "Updating Ubuntu packages..."
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get dist-upgrade -y
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          echo "Ubuntu update and upgrade completed"

      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Clear npm cache
        run: npm cache clean --force

      - name: Install dependencies
        run: npm ci

      - name: Setup environment
        run: |
          touch .env
          echo "${{ secrets.CLIPMIL_BE_ENV }}" > .env

      - name: Setup GCP credentials
        run: |
          echo "Creating GCP credentials files..."
          echo '${{ secrets.GCP_CREDENTIALS }}' > gcp-credentials.json
          echo '${{ secrets.GCP_SERVER_KEY }}' > gcp-servicekey.json
          echo "GCP credentials files created"

      - name: Build TypeScript
        run: npm run build

      - name: Install Docker if not present
        run: |
          if ! command -v docker &> /dev/null; then
            echo "Docker not found, installing from official Docker repository..."

            # Update package list
            sudo apt update

            # Install prerequisite packages
            sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

            # Add GPG key for official Docker repository
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

            # Add Docker repository to APT sources
            sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

            # Update package database with Docker packages
            sudo apt update

            # Install Docker
            sudo apt install -y docker-ce

            # Enable and start Docker service
            sudo systemctl enable docker
            sudo systemctl start docker

            echo "Docker installed successfully: $(docker --version)"
          else
            echo "Docker is already installed: $(docker --version)"
          fi

      - name: Add user to Docker group
        run: |
          # Add current user to docker group if not already added
          if ! groups $(whoami) | grep -q docker; then
            echo "Adding $(whoami) to docker group..."
            sudo usermod -aG docker $(whoami)
            echo "User added to docker group. Note: May require re-login for full effect."
          else
            echo "User $(whoami) is already in docker group"
          fi

      - name: Verify Docker is running
        run: |
          echo "Checking Docker daemon status..."
          sudo systemctl status docker --no-pager || true

          echo "Running Docker hello-world test..."
          sudo docker run --rm hello-world || docker run --rm hello-world

          echo "Docker info:"
          sudo docker info || docker info

      - name: Setup Redis container
        run: |
          REDIS_CONTAINER_NAME="clipmil-redis"

          # Check if Redis container already exists
          if sudo docker ps -a --format '{{.Names}}' | grep -q "^${REDIS_CONTAINER_NAME}$"; then
            echo "Redis container exists, checking status..."

            if sudo docker ps --format '{{.Names}}' | grep -q "^${REDIS_CONTAINER_NAME}$"; then
              echo "Redis container is already running"
            else
              echo "Starting existing Redis container..."
              sudo docker start ${REDIS_CONTAINER_NAME}
            fi
          else
            echo "Creating and starting new Redis container..."
            sudo docker run -d \
              --name ${REDIS_CONTAINER_NAME} \
              --restart unless-stopped \
              -p 6379:6379 \
              -v redis-data:/data \
              redis:alpine \
              redis-server --appendonly yes
          fi

          # Wait for Redis to be ready
          echo "Waiting for Redis to be ready..."
          sleep 3

          # Verify Redis is running
          sudo docker exec ${REDIS_CONTAINER_NAME} redis-cli ping || echo "Redis ping failed, but container may still be starting"

          echo "Redis container status:"
          sudo docker ps --filter "name=${REDIS_CONTAINER_NAME}"

      - name: Install PM2 if not present
        run: |
          if ! command -v pm2 &> /dev/null; then
            echo "PM2 not found, installing globally..."
            # Use full path to npm since sudo doesn't inherit PATH from actions/setup-node
            sudo env "PATH=$PATH" npm install -g pm2
          else
            echo "PM2 is already installed: $(pm2 -v)"
          fi

      - name: Clear PM2 cache and logs
        run: |
          pm2 flush || true
          pm2 reset all || true

      - name: Restart PM2 server
        run: |
          pm2 describe ${{ env.APP_NAME }} > /dev/null 2>&1 && pm2 restart ${{ env.APP_NAME }} || pm2 start dist/index.js --name ${{ env.APP_NAME }}
          pm2 save

      - name: Setup PM2 startup script
        run: |
          pm2 startup systemd -u $(whoami) --hp $HOME || true
          pm2 save

      - name: Install Nginx if not present
        run: |
          if ! command -v nginx &> /dev/null; then
            echo "Nginx not found, installing..."
            sudo apt-get update
            sudo apt-get install -y nginx
            sudo systemctl enable nginx
            sudo systemctl start nginx
          else
            echo "Nginx is already installed: $(nginx -v 2>&1)"
          fi

      - name: Setup Nginx configuration
        if: ${{ env.DOMAIN != '' }}
        run: |
          NGINX_CONF="/etc/nginx/sites-available/${{ env.APP_NAME }}"
          echo "Creating/Updating Nginx configuration for ${{ env.APP_NAME }}..."
          sudo tee $NGINX_CONF > /dev/null <<EOF
          server {
              listen 80;
              server_name ${{ env.DOMAIN }};

              location / {
                  proxy_pass http://localhost:${{ env.APP_PORT }};
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;
                  proxy_read_timeout 86400;
              }
          }
          EOF

          # Enable the site
          sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/${{ env.APP_NAME }}

          # Remove default site if exists
          sudo rm -f /etc/nginx/sites-enabled/default || true

          echo "Nginx configuration created and enabled"

      - name: Test and reload Nginx
        if: ${{ env.DOMAIN != '' }}
        run: |
          sudo nginx -t
          sudo systemctl reload nginx

      - name: Install Certbot if not present
        if: ${{ env.DOMAIN != '' }}
        run: |
          if ! command -v certbot &> /dev/null; then
            echo "Certbot not found, installing..."
            sudo apt-get update
            sudo apt-get install -y certbot python3-certbot-nginx
          else
            echo "Certbot is already installed: $(certbot --version 2>&1)"
          fi

      - name: Setup SSL with Certbot
        if: ${{ env.DOMAIN != '' }}
        run: |
          # Check if certificate already exists for the domain
          if [ ! -d "/etc/letsencrypt/live/${{ env.DOMAIN }}" ]; then
            echo "SSL certificate not found, obtaining new certificate..."
            sudo certbot --nginx -d ${{ env.DOMAIN }} --non-interactive --agree-tos --email ${{ env.CERTBOT_EMAIL }} --redirect
          else
            echo "SSL certificate already exists, checking for renewal..."
            sudo certbot renew --dry-run || true
          fi

      - name: Setup Certbot auto-renewal cron
        if: ${{ env.DOMAIN != '' }}
        run: |
          # Add cron job for auto-renewal if not already present
          if ! sudo crontab -l 2>/dev/null | grep -q "certbot renew"; then
            echo "Setting up Certbot auto-renewal cron job..."
            (sudo crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | sudo crontab -
          else
            echo "Certbot auto-renewal cron job already exists"
          fi

      - name: Final Nginx restart
        if: ${{ env.DOMAIN != '' }}
        run: |
          sudo nginx -t
          sudo systemctl restart nginx

      - name: Clear Actions runner cache
        run: |
          rm -rf ~/.npm/_cacache
          rm -rf /tmp/*npm* || true

      - name: Health check
        run: |
          sleep 5
          curl -f http://localhost:${{ env.APP_PORT }} || echo "Health check endpoint not available (this may be expected)"
